<!DOCTYPE html>
<html>
<head>
    <link href="/app.css" rel="stylesheet" />
    <script type="text/javascript" src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
    <script>
        const appId = '{APPLICATION_ID}';
        const locationId = '{LOCATION_ID}';

        async function initializeCard(payments) {
            const card = await payments.card();
            await card.attach('#card-container');

            return card;
        }

        async function createPayment(token, verificationToken) {
            const body = JSON.stringify({
                locationId,
                sourceId: token,
                verificationToken,
                idempotencyKey: window.crypto.randomUUID(),
            });

            const paymentResponse = await fetch('http://localhost:8080/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body,
            });

            if (paymentResponse.ok) {
                return paymentResponse.json();
            }

            const errorBody = await paymentResponse.text();
            throw new Error(errorBody);
        }

        async function tokenize(paymentMethod) {
            const tokenResult = await paymentMethod.tokenize();
            if (tokenResult.status === 'OK') {
                return tokenResult.token;
            } else {
                let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
                if (tokenResult.errors) {
                    errorMessage += ` and errors: ${JSON.stringify(tokenResult.errors)}`;
                }

                throw new Error(errorMessage);
            }
        }

        async function verifyBuyer(payments, token) {
            const verificationDetails = {
                amount: '1.00',
                billingContact: {
                    givenName: 'John',
                    familyName: 'Doe',
                    email: 'john.doe@square.example',
                    phone: '3214563987',
                    addressLines: ['123 Main Street', 'Apartment 1'],
                    city: 'London',
                    state: 'LND',
                    countryCode: 'GB',
                },
                currencyCode: 'GBP',
                intent: 'CHARGE',
            };

            const verificationResults = await payments.verifyBuyer(
                token,
                verificationDetails,
            );
            return verificationResults.token;
        }

        // status is either SUCCESS or FAILURE;
        function displayPaymentResults(status) {
            const statusContainer = document.getElementById(
                'payment-status-container',
            );
            if (status === 'SUCCESS') {
                statusContainer.classList.remove('is-failure');
                statusContainer.classList.add('is-success');
            } else {
                statusContainer.classList.remove('is-success');
                statusContainer.classList.add('is-failure');
            }

            statusContainer.style.visibility = 'visible';
        }

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                if (!window.Square) {
                    throw new Error('Square.js failed to load properly');
                }

                let payments;
                try {
                    payments = window.Square.payments(appId, locationId);
                } catch (error) {
                    throw new Error('Failed to initialize Square payments: ' + error.message);
                }

                let card;
                try {
                    card = await initializeCard(payments);
                } catch (error) {
                    throw new Error('Failed to initialize card: ' + error.message);
                }

                const cardButton = document.getElementById('card-button');
                cardButton.addEventListener('click', async function (event) {
                    event.preventDefault();

                    // disable the submit button as we await tokenization and make a payment request.
                    cardButton.disabled = true;
                    try {
                        const token = await tokenize(card);
                        const verificationToken = await verifyBuyer(payments, token);
                        const paymentResults = await createPayment(
                            token,
                            verificationToken,
                        );
                        displayPaymentResults('SUCCESS');

                        console.debug('Payment Success', paymentResults);
                    } catch (error) {
                        cardButton.disabled = false;
                        displayPaymentResults('FAILURE');
                        window.alert('Payment failed: ' + error.message);
                    }
                });

            } catch (error) {
                window.alert(error.message);
            }
        });
    </script>
</head>
<body>
    <form id="payment-form">
        <div id="card-container"></div>
        <button id="card-button" type="button">Pay $1.00</button>
    </form>
    <div id="payment-status-container"></div>
</body>
</html>
