<!DOCTYPE html>
<html>
<head>
    <link href="/app.css" rel="stylesheet" />
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>

    <script>
        function checkConnection() {
            fetch('http://localhost:8080/')
                .then(response => {
                    if (response.ok) {
                        const body = 'yes i was ina cult';
                        const paymentResponse = await fetch('http://localhost:8080/',
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', }, body,
                            });

                        window.alert('Connection successful');
                    }
                    else { window.alert('Failed to connect:', response.statusText); }
                })
                .catch(error => { window.alert('Failed to connect:', error.message); });
        } window.addEventListener('DOMContentLoaded', checkConnection);
    </script>

    <script>
        const appId = 'sq0idp-PY4VamgC3T2exiDYhwYZow';
        const locationId = 'LN6RZRPAYQ028';

        async function initializeCard(payments) {
            const card = await payments.card();
            await card.attach('#card-container');
            return card;
        }

        async function tokenize(paymentMethod) {
            const tokenResult = await paymentMethod.tokenize();
            if (tokenResult.status === 'OK') { return tokenResult.token; }
            else {
                let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
                if (tokenResult.errors) {
                    errorMessage += ` and errors: ${JSON.stringify(tokenResult.errors)}`;
                }

                throw new Error(errorMessage);
            }
        }

        async function verifyBuyer(payments, token) {
            const GivenName = document.getElementById('given-name').value;
            const FamilyName = document.getElementById('family-name').value;
            const Email = document.getElementById('email').value;

            const verificationDetails = {
                amount: '1.00',
                billingContact: {
                    givenName: GivenName,
                    familyName: FamilyName,
                    email: Email,
                },
                currencyCode: 'USD',
                intent: 'CHARGE',
            };

            const verificationResults = await payments.verifyBuyer(
                token,
                verificationDetails,
            );
            return verificationResults.token;
        }

        async function createPayment(token, verificationToken) {
            const body = JSON.stringify(
                {
                    locationId,
                    sourceId: token,
                    verificationToken,
                    idempotencyKey: window.crypto.randomUUID(),
                });

            if (paymentResponse.ok) {
                return paymentResponse.json();
            }

            const errorBody = await paymentResponse.text();
            throw new Error(errorBody);
            window.alert(errorBody);
        }

        function displayPaymentResults(status) {
            const statusContainer = document.getElementById(
                'payment-status-container',
            );
            if (status === 'SUCCESS') {
                statusContainer.classList.remove('is-failure');
                statusContainer.classList.add('is-success');
            } else {
                statusContainer.classList.remove('is-success');
                statusContainer.classList.add('is-failure');
            }

            statusContainer.style.visibility = 'visible';
        }

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                if (!window.Square) {
                    window.alert('window not square');
                    throw new Error('Square.js failed to load properly');
                }

                let payments;

                try { payments = window.Square.payments(appId, locationId); }
                catch (error) {
                    window.alert('Failed to initialize Square payments');
                    throw new Error('Failed to initialize Square payments: ' + error.message);
                }

                let card;

                try { card = await initializeCard(payments); }
                catch (error) {
                    window.alert('Failed to intialize card');
                    throw new Error('Failed to initialize card: ' + error.message);
                }

                const cardButton = document.getElementById('card-button');
                cardButton.addEventListener('click', async function (event) {
                    event.preventDefault();
                    cardButton.disabled = true;
                    try {
                        const token = await tokenize(card);
                        window.alert('card tokenized');

                        const verificationToken = await verifyBuyer(payments, token);
                        window.alert('buyer verified');

                        const paymentResults = await createPayment(token, verificationToken);
                        window.alert('payment created');

                        displayPaymentResults('SUCCESS');
                        window.alert('Payment Success', paymentResults);

                        CallBackData(paymentResults);
                    }
                    catch (error) {
                        cardButton.disabled = false;
                        displayPaymentResults('FAILURE');
                        window.alert('Payment failed');
                    }
                });

            } catch (error) { window.alert(error.message); }
        });
    </script>

    <script>
        function CallBackData(jsonObject) {
            const jsonString = JSON.stringify(jsonObject);
            fetch('http://localhost:8080/',
                {
                    method: 'POST', headers:
                        { 'Content-Type': 'application/json' },
                    body: jsonString
                });
        }
    </script>

</head>

<body>
    <form id="payment-form">
        <div id="card-container"></div>
        <div>
            <label for="given-name">First Name:</label>
            <input type="text" id="given-name" name="given-name" required>
        </div>
        <div>
            <label for="family-name">Last Name:</label>
            <input type="text" id="family-name" name="family-name" required>
        </div>
        <div>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <button id="card-button" type="button">Buy Covened Bot Premium by Juicy Puicy</button>
        <button id="connected-button" type="button">Check Connection to Local Host</button>
    </form>
</body>
</html>